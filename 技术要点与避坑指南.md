# 🛡️ Geek Killer Pro - 技术要点与避坑指南

> 本文档总结了 `Geek Killer Pro` (v2.0) 开发过程中的核心技术架构、遇到的“坑”以及最终的解决方案，供后续维护或类似项目参考。

## 🏗️ 核心架构

### 1. 暴力美学：Smart Eject 策略
针对 Windows 平台顽固的“硬件拒绝弹出 (VetoType 6)”问题，我们摒弃了传统的“温和释放”，采用了分层级进的“暴力弹出”策略：

1.  **Level 1: 极速弹出 (Eject-First)**
    - **逻辑**：用户点击时，直接调用 `CM_Request_Device_EjectW`。
    - **优势**：90% 的情况下 U 盘并未被锁定，此操作可实现“零延迟”秒弹，无须等待扫描。

2.  **Level 2: 智能扫描 (Smart Scan)**
    - **逻辑**：仅当 L1 失败时，启动 `Restart Manager` (RM) 扫描占用进程。
    - **补位**：若 RM 失效（如某些流氓软件），回退到 `sysinfo` 扫描，检查所有进程的 `ExePath` 和 `CWD` 是否指向目标盘符。

3.  **Level 3: 强力清场 (Force Kill)**
    - **逻辑**：`RmShutdown` (强杀) + `Kill PID` (补刀)。
    - **关键**：杀完进程后，**必须**等待 200-300ms 让系统释放句柄，否则后续弹出仍会失败。

4.  **Level 4: 核弹级卸载 (Dismount & Parent Eject)**
    - **逻辑**：
        1.  `FlushFileBuffers`: 刷盘，防数据丢失。
        2.  `FSCTL_LOCK_VOLUME`: 尝试锁定卷。
        3.  `FSCTL_DISMOUNT_VOLUME`: **强制卸载卷**（核心大招）。
        4.  `CM_Get_Parent` + `CM_Request_Device_EjectW`: 尝试弹出**父设备**（解决复合设备无法弹出的问题）。

### 2. 鲁棒性：极简模式 (Panic Mode)
为了在系统极度卡顿（如 CPU 100%）时仍能救急，实现了自适应资源调度：

- **触发条件**：CPU > 90% 或 内存 < 500MB (连续 3 次采样)。
- **降级行为**：
    - **UI**：自动折叠性能面板、普通进程列表，仅保留“极高负载任务”和“U盘管理”。
    - **调度**：后台监控线程刷新率从 `2Hz` (500ms) 降至 `0.5Hz` (2000ms)。
- **实现细节**：
    - 使用 `try_read()` 替代阻塞锁，确保 UI 线程永远不会被后台卡死。
    - 数据传递使用 `Arc<AppSnapshot>` 实现写时复制（CoW）/ 零拷贝更新。

---

## 🕳️ 避坑指南 (Pitfalls)

### 1. Win32 API 的坑
- **`Restart Manager` 不万能**：RM 经常漏掉“只读打开”文件的进程（如记事本）。必须配合手动扫描（遍历 Process 的 exe/cwd）。
- **`CloseHandle` 必须成对**：在 `unsafe` 块中打开的 Handle (`CreateFileW`) 必须显式关闭，否则会导致文件一直被本程序占用，出现“自己锁死自己”的尴尬。
- **`SetupDiGetDeviceInterfaceDetail` 内存对齐**：`SP_DEVICE_INTERFACE_DETAIL_DATA_W` 结构体的 `cbSize` 必须正确设置（通常是 `size_of::<SP_DEVICE_INTERFACE_DETAIL_DATA_W>()`，但在某些环境下是 `8` 或 `5`，Rust 中需小心 `repr(C)` 布局）。

### 2. Rust UI 开发 (egui)
- **中文乱码/方块**：默认字体不支持中文。必须加载 `MiSans` 或 `Source Han Sans` 等中文字体。
- **UI 跳动**：不要在 `update` 循环中直接修改列表长度。解决方案是：
    1.  固定容器高度 (`max_height`)。
    2.  使用 `ScrollArea`。
    3.  后台线程准备好数据后，原子替换 UI 缓存 (`Arc` 交换)。
- **阻塞主线程**：严禁在 `update` 中执行 I/O 操作（如扫描磁盘、查询图标）。必须放到 `std::thread` 中，通过 `mpsc` 通道通信。

### 3. Windows 路径与权限
- **管理员权限**：强制杀进程和 `Dismount` 卷必须有 Admin 权限。建议在 `app.manifest` 中配置 `requireAdministrator`，或在代码中检测并提示。
- **路径前缀**：操作物理驱动器时，路径要是 `\\.\E:` 或 `\\.\PhysicalDrive1`。普通的 `E:` 很多 API 不认。

---

## 🛠️ 编译与发布
- **减小体积**：`Cargo.toml` 中开启 `lto = true`, `strip = true`, `opt-level = "z"`。
- **静态链接**：确保不依赖 `MSVC` 动态库（Rust 默认静态链接 CRT，通常没问题，但需注意某些 C++ 依赖）。
